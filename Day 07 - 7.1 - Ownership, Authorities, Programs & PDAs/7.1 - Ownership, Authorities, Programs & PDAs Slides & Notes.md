# 7.1 - Ownership, Authorities, Programs & PDAs

> **Course**: 100xDevs Cohort 3.0 — Web3 Track
> **Instructor**: Harkirat Singh
> **Week**: 7.1
> **Slides**: https://petal-estimate-4e9.notion.site/Ownership-Authorities-Programs-and-PDAs-b2b8bfeae8064753982be9bd67afbb7b
> **Notes**: https://feather-lion-ff2.notion.site/Week-7-1-92fcd8f45fd44550bc0c65a232ea4cfd

---

## Topics Covered Today

1. Accounts on Solana — deep dive
2. System Program — native programs, wallet creation
3. BPF Loader Program — deploying & upgrading custom programs
4. Authority in Solana Programs — mint, freeze, upgrade
5. Creating and revoking mint authority (CLI)
6. Program Derived Addresses (PDAs) — deep dive
7. Summary

---

## 1. Accounts on Solana

### What are Solana Accounts?

In Solana, **accounts** are places where **data** is stored. Think of them like **lockers** in a large warehouse. Each locker (account) can hold data like program code (instructions) or user data.

**Ref**: https://solana.com/docs/core/accounts

> On Solana, all data is stored in what are referred to as "accounts". The way data is organized on Solana resembles a **key-value store**, where each entry in the database is called an "account".

### Key Points

1. **Accounts store data**:
   - They can store up to **10MB** (how much space you have in a locker)
   - Some lockers store **program code** (rules or instructions that do things)
   - Some lockers store **data** (information used by the program)

2. **Rent Deposit**:
   - To keep a locker (account), you need to pay rent in **SOL**, but you get it back when you close the account
   - Accounts must be **rent-exempt** — hold enough lamports to persist indefinitely

3. **Owner and Permissions**:
   - Each locker (account) has an **owner** — only the owner can make changes to the data inside
   - **Others can add money (SOL)** to the locker, but they can't change what's inside

4. **Native Programs**:
   - Some lockers come with built-in programs (like pre-installed software) that Solana provides

### Real-Life Example — Gym Locker

- Your **locker number** (key) is unique, just like each Solana account has a unique **address**
- Inside your locker you might store **gym clothes** (data) or **instructions** for workouts (program code)
- You **pay rent** for using the locker, but if you stop using it, you get your deposit back
- Only **you** (the owner) can open the locker and change what's inside, but someone else can still **add money** to your locker

### So, in simple terms

On Solana, all data is stored in accounts. The data is organized like a **key-value store**, where each entry in the database is called an "account".

```
Accounts
┌─────────────────┬─────────────────┐
│       Key       │      Value      │
├─────────────────┼─────────────────┤
│    Address      │   AccountInfo   │
│    Address      │   AccountInfo   │
│    Address      │   AccountInfo   │
└─────────────────┴─────────────────┘
```

### What is an Account?

In Solana, an account is like a **mailbox** where you store data. Each account has a **unique address** — 32 bytes long, works like a **public key** (using ed25519 cryptography standard).

### AccountInfo Structure

Accounts have a max size of **10MB**. The data stored on every account on Solana has the following structure:

```
Address
Account {
  AccountInfo:
    Data: Bytes          ← actual data stored (bytes)
    Executable: Boolean  ← true = program account, false = data account
    Lamports: Number     ← SOL balance (in lamports)
    Owner: Program Address ← which program controls this account
}
```

> Even if you store no data, you still have to store fields like `executable` and `owner` — which is why you still have to have a minimum amount of SOL as rent.

### Real-Life Example — Netflix Account

Imagine an online subscription service like Netflix:
- Your **account** is like your profile in their system
- Your profile has:
  1. **Data**: Your watch history
  2. **Executable**: A program that recommends new shows based on your history
  3. **Money (Lamports)**: The credits you have to spend in the system
  4. **Owner**: Netflix owns the overall system, but only you can update your watch history

### Example Accounts on Solana Explorer

- **Account with no data** (Owner = SystemProgram): https://explorer.solana.com/address/5gLJXtBNCWL8nwGKprThQwyzqNZ7VNARFcEtw3rD4I
- **Account with some data** (Owner = TokenProgram): https://explorer.solana.com/address/8FGq9Bd-rB57wb2fTQVaWbkjR2sNNxDLyabNePPmsycuR
- **Program account** (Owner = BPF Loader): TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA

---

## 2. System Program

Solana contains a small handful of **native programs** that are part of the validator implementation and provide various core functionalities for the network.

When developing custom programs on Solana, you will commonly interact with two native programs: the **System Program** and the **BPF Loader**.

### Solana's Native Programs

On Solana, there are a few **built-in programs** that help the network function. Think of these as **essential services** that keep everything running smoothly. The two most important ones are the **System Program** and the **BPF Loader**.

### System Program

By default, all new accounts are owned by the **System Program**. The System Program performs several key tasks:

1. **New Account Creation**: Only the System Program can create new accounts
   - Like a **bank manager** that can open bank accounts for you
2. **Space Allocation**: Sets the byte capacity for the data field of each account
   - Like getting a **safe deposit box** — the size is set by the System Program
3. **Assign Program Ownership**: Once the System Program creates an account, it can reassign the designated program owner to a different program account — this is how custom programs take ownership of new accounts created by the System Program

### Real-Life Example — IT Department

Think of the System Program as the **IT department** in a company:
- **New Account Creation**: Only the IT department can create new user accounts
- **Space Allocation**: IT also gives you a specific amount of space on company servers
- **Assign Ownership**: Once your account is created, they hand over ownership to you

### Wallet on Solana

A **wallet** on Solana is like a bank account created by the System Program. It holds **SOL tokens** (the currency) and the total balance is called the **lamport balance**.

```
Address
System Program
    ↓ owner
Address
Wallet Account {
  AccountInfo:
    Data: None
    Executable: False
    Lamports: 1,000,000
    Owner: System Program
}
```

### Using @solana/web3.js to interact with the System Program

```js
// 1. Create a new account with data and rent
const { Keypair, Connection, SystemProgram, Transaction } = require('@solana/web3.js');
const payer = Keypair.fromSecretKey(Uint8Array.from([222,61,198,38,98,70,4,221,38,76,34,...]))
const mintAuthority = payer;
const connection = new Connection("https://api.devnet.solana.com");
async function main() {
  const newAccount = Keypair.generate();
  const lamports = await connection.getMinimumBalanceForRentExemption(TOTAL_BYTES);
  const transaction = new Transaction().add(
    SystemProgram.createAccount({
      fromPubkey: payer.publicKey,
      newAccountPubkey: newAccount.publicKey,
      lamports: lamports,
      space: TOTAL_BYTES,
      programId: SystemProgram.programId,
    })
  );
  await connection.sendTransaction(transaction, [payer, newAccount]);
  console.log("New account created at", newAccount.publicKey.toBase58());
}
main();
```

```js
// 2. Transfer lamports from your account to another account
async function transfer() {
  const newAccount = Keypair.generate();
  const TOTAL_BYTES = 400;
  const lamports = await connection.getMinimumBalanceForRentExemption(TOTAL_BYTES);
  const transaction = new Transaction().add(
    SystemProgram.transfer({
      fromPubkey: payer.publicKey,
      toPubkey: newAccount.publicKey,
      lamports,
    })
  );
  await connection.sendTransaction(transaction, [payer, newAccount]);
  console.log("Transferred to", newAccount.publicKey.toBase58());
}
```

```js
// 3. Change the owner of an account
async function changeOwner() {
  const newAccount = Keypair.generate();
  const owner = Keypair.generate();
  const TOTAL_BYTES = 400;
  const lamports = await connection.getMinimumBalanceForRentExemption(TOTAL_BYTES);
  const transaction = new Transaction().add(
    SystemProgram.createAccount({
      fromPubkey: payer.publicKey,
      newAccountPubkey: newAccount.publicKey,
      lamports: lamports,
      space: TOTAL_BYTES,
      programId: owner.publicKey,  // ← sets owner to a custom program
    })
  );
  await connection.sendTransaction(transaction, [payer, newAccount]);
  console.log("New account created at", newAccount.publicKey.toBase58());
}
```

---

## 3. BPF Loader Program

The **BPF Loader** is the program designated as the **"owner" of all other programs** on the network, excluding Native Programs. It is responsible for **deploying, upgrading, and executing** custom programs.

> The BPF Loader is like the **software manager** for the Solana network. It handles all the custom programs (smart contracts) that developers create.

### What BPF Loader does

1. **Deploy Programs**: Just like a software manager installs new apps on a computer, the BPF Loader installs new programs (smart contracts) on the Solana network
2. **Upgrade Programs**: If a developer needs to make changes or improve an existing program, the BPF Loader is responsible for upgrading it
3. **Execute Programs**: Once the programs are deployed, the BPF Loader runs them

### Real-Life Example

Imagine you're in a company and the **IT department** (BPF Loader) is responsible for:
- **Installing new software** (deploying programs) on all employees' computers
- **Updating the software** when a new version is available (upgrading programs)
- **Running the software** whenever an employee needs to use it (executing programs)

### In Simple Terms

The BPF Loader is the program designated as the "owner" of all other programs on the network, excluding Native Programs.

```json
// A deployed program account looks like:
{
  "value": {
    "data": ["AgAAAHIUrXz9wYQNxfiS2WpxNe7z8SnPNTd8icDIJU5gUWai", "base64"],
    "executable": true,
    "lamports": 1398960,
    "owner": "BPFLoaderUpgradeable11111111111111111111111",
    "rentEpoch": 18446744073709551615,
    "space": 36
  }
}
```

Note: `executable: true` — this is what distinguishes program accounts from data accounts.

---

## 4. Authority in Solana Programs

In Solana, **authority** refers to the **person or account** that has the **permission to make decisions** or perform certain actions in a program. Just like in real life, some actions need approval or permission from the right person.

### Types of Authority

- **Token mint authority** — Can mint new tokens
  - Token with mint auth: https://explorer.solana.com/address/EPJFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v
  - Token with NO mint auth (fixed supply): https://explorer.solana.com/address/8FQvj8xFdRS1wb2fTQVaWbkjR2sNNxDLyabNePPmsyou9

- **Token freeze authority** — Can freeze tokens in an account
  - Token with freeze auth: https://explorer.solana.com/address/EPJFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v

- **Upgrade authority** — Can upgrade the code of a program
  - https://explorer.solana.com/address/8rpHNPsyEJQEJjC2waWvUXyvCkYghCZndACoXs9sNKZg?cluster=devnet

---

## 5. Creating and Revoking Mint Authority (CLI)

```bash
# Create a new token
spl-token create-token

# Create an associated token account (ATA)
spl-token create-account <token_mint_address>

# Try minting some tokens
spl-token mint <token_mint_address> 10000000000

# Check if mint_authority exists on explorer
# → You'll see "Mint Authority" field showing your wallet address

# Revoke mint authority (permanently caps supply)
spl-token authorize <token_id> mint --disable

# Try to mint again → should FAIL
spl-token mint <token_mint_address> 10000000000
# Error: "Transaction simulation failed: Error processing Instruction 0..."
# Mint authority has been permanently removed — supply is now FIXED
```

After revoking, the token on Solana explorer shows **no Mint Authority** — the supply is now fixed forever. This is a trust signal for token holders.

---

## 6. Program Derived Addresses (PDAs)

**Ref**: https://solana.com/docs/core/pda
**Video**: https://www.youtube.com/watch?v=p0eD29d8JCM

PDAs provide developers on Solana with two main use cases:

1. **Deterministic Account Addresses**: PDAs provide a mechanism to deterministically derive an address using a combination of optional **seeds** (predefined inputs) and a specific **program ID**
2. **Enable Program Signing**: The Solana runtime enables programs to "sign" for PDAs which are derived from its program ID

### Properties of PDAs

- PDAs are addresses derived deterministically using:
  - A combination of user-defined seeds
  - A bump seed
  - A program's ID
- PDAs are addresses that **fall off the Ed25519 curve** and have **no corresponding private key**
- Solana programs can programmatically **"sign" for PDAs** that are derived using its program ID
- Deriving a PDA does **not** automatically create an on-chain account
- An account using a PDA as its address must be explicitly created through a dedicated instruction within a Solana program

### ATA is a PDA

```
ATA(user1) = Token program + Token mint acc + user1_address
                   ↓
          Associated token account program
                   ↓
           ATA (user1)
```

The ATA is a PDA derived from:
- Token Program ID
- User's wallet address (seed)
- Token mint address (seed)

### Find the associated token account for a user and a mint

```js
const { PublicKey } = require('@solana/web3.js');
const { ASSOCIATED_TOKEN_PROGRAM_ID, TOKEN_PROGRAM_ID } = require('@solana/spl-token');

// Replace these with your actual values
const userAddress = new PublicKey('5gLJXtBDDWdWL4nwdUKprThQwyzqNZ7VNARFcEtw3rD4I');
const tokenMintAddress = new PublicKey('4Ne8R25TEEb6CPZ5GsdJydb1AkabdrIMdIxeMWC2U9hcJs');

const getAssociatedTokenAddress = (mintAddress, ownerAddress) => {
  return PublicKey.findProgramAddressSync(
    [
      ownerAddress.toBuffer(),
      TOKEN_PROGRAM_ID.toBuffer(),
      mintAddress.toBuffer(),
    ],
    ASSOCIATED_TOKEN_PROGRAM_ID
  );
};

const [associatedTokenAddress, bump] = getAssociatedTokenAddress(tokenMintAddress, userAddress);
console.log(`Associated Token Address: ${associatedTokenAddress.toBase58()}, Bump: ${bump}`);
```

### `createProgramAddress` vs `findProgramAddress`

```js
// createProgramAddress — you provide the bump yourself
const PDA = PublicKey.createProgramAddressSync(
  [userAddress.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), tokenMintAddress.toBuffer(), Buffer],
  ASSOCIATED_TOKEN_PROGRAM_ID,
);
console.log("PDA:", `${PDA}`);

// findProgramAddressSync — auto-finds valid bump (more common)
const [pda, bump] = PublicKey.findProgramAddressSync(
  [userAddress.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), tokenMintAddress.toBuffer()],
  ASSOCIATED_TOKEN_PROGRAM_ID
);
```

**Key difference**:
- `createProgramAddressSync` — you provide the bump, can fail if address is on the curve
- `findProgramAddressSync` — automatically iterates bump from 255 down until it finds a valid off-curve address

---

## Summary

- Solana accounts are like **lockers** that store data (up to 10MB) and require rent in SOL to maintain
- The **System Program** is responsible for creating new accounts, allocating space, and assigning program ownership
- The **BPF Loader Program** manages custom programs (smart contracts) by deploying, upgrading, and executing them
- **Authority** in Solana refers to the account or person with permission to make decisions or perform actions in a program
- Different types of authorities exist: **token mint authority**, **token freeze authority**, and **upgrade authority**
- **Mint authority** can be created and revoked for tokens, affecting the ability to mint new tokens
- **PDAs** are deterministic addresses derived from seeds + program ID, with no private key — only the program can sign for them

---

## Key Concepts Table

| Concept | Description |
|---|---|
| Account | Key-value store entry on Solana — holds data, lamports, owner, executable flag |
| AccountInfo | The value stored at each account address: Data, Executable, Lamports, Owner |
| Rent | SOL deposit required to keep an account alive (refundable on close) |
| System Program | Native program that creates accounts, allocates space, assigns ownership |
| BPF Loader | Owner of all custom programs — deploys, upgrades, executes them |
| Authority | Account with permission to perform specific actions (mint, freeze, upgrade) |
| Mint Authority | Who can mint new tokens — can be revoked to cap supply permanently |
| Freeze Authority | Who can freeze token accounts — set null to disable |
| Upgrade Authority | Who can upgrade a deployed program's code |
| PDA | Program Derived Address — deterministic, off Ed25519 curve, no private key |
| Bump Seed | Extra byte (0-255) used to push address off the ed25519 curve |
| ATA | Associated Token Account — a PDA derived from wallet + mint + Token Program |

---

## References

- Slides: https://petal-estimate-4e9.notion.site/Ownership-Authorities-Programs-and-PDAs-b2b8bfeae8064753982be9bd67afbb7b
- Week 7.1 Notes: https://feather-lion-ff2.notion.site/Week-7-1-92fcd8f45fd44550bc0c65a232ea4cfd
- Solana Accounts Docs: https://solana.com/docs/core/accounts
- Solana PDA Docs: https://solana.com/docs/core/pda
- PDA Video: https://www.youtube.com/watch?v=p0eD29d8JCM
